<!DOCTYPE html>
<html>
<head>
    <title>Custom Chart</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Calculator",{config:{calculationType:void 0,field:void 0},constructor:function(config){this.initConfig(config)},prepareChartData:function(store){var data=this._groupData(store),categories=_.keys(data),seriesData;return seriesData="count"===this.calculationType?_.map(data,function(value,key){return[key,value.length]}):_.map(data,function(value,key){var valueTotal=_.reduce(value,function(total,r){var valueField=this._getValueFieldForCalculationType();return total+r.get(valueField)},0,this);return[key,valueTotal]},this),{categories:categories,series:[{name:this.field,type:this.seriesType,data:seriesData}]}},_groupData:function(store){if("collection"===store.model.getField(this.field).getType()){var groups={};return _.each(store.getRange(),function(record){var value=record.get(this.field),values=value._tagsNameArray;_.isEmpty(values)?(groups.None=groups.None||[],groups.None.push(record)):_.each(values,function(val){groups[val.Name]=groups[val.Name]||[],groups[val.Name].push(record)})},this),groups}return _.groupBy(store.getRange(),function(record){return this._getDisplayValueForField(record,this.field)},this)},_getDisplayValueForField:function(record,fieldName){var value=record.get(fieldName);if(_.isObject(value))return value._refObjectName;if(Ext.isEmpty(value)){var field=record.getField(fieldName),fieldType=field.getType();return"User"===field.attributeDefinition.SchemaType?"-- No Owner --":"rating"===fieldType||"object"===fieldType?"None":"-- No Entry --"}return value},_getValueFieldForCalculationType:function(){switch(this.calculationType){case"acceptedleafcount":return"AcceptedLeafStoryCount";case"acceptedleafplanest":return"AcceptedLeafStoryPlanEstimateTotal";case"leafcount":return"LeafStoryCount";case"leafplanest":return"LeafStoryPlanEstimateTotal";case"prelimest":return"PreliminaryEstimateValue";default:return"PlanEstimate"}}});
                Ext.define("BarCalculator",{extend:"Calculator",seriesType:"bar"});
                Ext.define("BarChart",{xtype:"barchart",extend:"Rally.ui.chart.Chart",requires:["BarCalculator"],chartConfig:{chart:{type:"bar"},title:{text:""},tooltip:{headerFormat:"",pointFormat:"{point.name}: <b>{point.y}</b>"},yAxis:{min:0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:"gray"}}},legend:!1,plotOptions:{bar:{stacking:"normal",dataLabels:{enabled:!1},showInLegend:!1,colorByPoint:!0}}},calculatorType:"BarCalculator"});
                Ext.define("ColumnCalculator",{extend:"Calculator",seriesType:"column"});
                Ext.define("ColumnChart",{xtype:"columnchart",extend:"Rally.ui.chart.Chart",requires:["ColumnCalculator"],chartConfig:{chart:{type:"column"},title:{text:""},tooltip:{headerFormat:"",pointFormat:"{point.name}: <b>{point.y}</b>"},yAxis:{min:0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:"gray"}}},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!1},showInLegend:!1,colorByPoint:!0}}},calculatorType:"ColumnCalculator"});
                Ext.define("PieCalculator",{extend:"Calculator",seriesType:"pie"});
                Ext.define("PieChart",{xtype:"piechart",extend:"Rally.ui.chart.Chart",requires:["PieCalculator"],chartConfig:{chart:{type:"pie",plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:""},tooltip:{headerFormat:"",pointFormat:"{point.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %",style:{color:"black"}}}}},calculatorType:"PieCalculator"});
                Ext.define("CustomChartApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",config:{defaultSettings:{types:"defect",chartType:"piechart",aggregationField:"State",aggregationType:"count",query:""}},launch:function(){this.getSetting("types")?Rally.data.wsapi.ModelFactory.getModels({types:this._getTypesSetting()}).then({success:this._onModelsLoaded,scope:this}):this.fireEvent("appsettingsneeded")},getSettingsFields:function(){var me=this;return[{name:"chartType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Chart Type",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:Ext.create("Ext.data.Store",{fields:["name","value"],data:[{name:"Bar",value:"barchart"},{name:"Column",value:"columnchart"},{name:"Pie",value:"piechart"}]})},{name:"types",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Type",shouldRespondToScopeChange:!0,context:this.getContext(),storeConfig:{model:"TypeDefinition",sorters:[{property:"DisplayName"}],fetch:["DisplayName","TypePath"],filters:[{property:"UserListable",value:!0}],autoLoad:!1,remoteSort:!1,sortOnLoad:!0,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(combo){combo.fireEvent("typeselected",combo.getValue(),combo.context)},ready:function(combo){combo.fireEvent("typeselected",combo.getValue(),combo.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(context){this.refreshWithNewContext(context)}}},{name:"aggregationField",xtype:"rallyfieldcombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregate By",readyEvent:"ready",allowBlank:!1,validateOnChange:!1,validateOnBlur:!1,width:300,handlesEvents:{typeselected:function(models,context){var type=Ext.Array.from(models)[0];type?this.refreshWithNewModelType(type,context):(this.store.removeAll(),this.reset())}},listeners:{ready:function(combo){combo.store.filterBy(function(record){var field=record.get("fieldDefinition"),attr=field.attributeDefinition,whiteList=["Tags","Milestones"];return attr&&!attr.Hidden&&(("COLLECTION"!==attr.AttributeType||field.isMultiValueCustom())&&!field.isMappedFromArtifact||_.contains(whiteList,field.name))});var fields=Ext.Array.map(combo.store.getRange(),function(record){return record.get(combo.getValueField())});Ext.Array.contains(fields,combo.getValue())||combo.setValue(fields[0])}}},{name:"aggregationType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregation Type",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,width:300,store:{fields:["name","value"],data:[{name:"Accepted Leaf Story Count",value:"acceptedleafcount"},{name:"Accepted Leaf Story Plan Estimate Total",value:"acceptedleafplanest"},{name:"Count",value:"count"},{name:"Plan Estimate Total",value:"estimate"},{name:"Leaf Story Count",value:"leafcount"},{name:"Leaf Story Plan Estimate Total",value:"leafplanest"},{name:"Preliminary Estimate Value",value:"prelimest"}]},lastQuery:"",handlesEvents:{typeselected:function(types){var type=Ext.Array.from(types)[0];Rally.data.ModelFactory.getModel({type:type,success:function(model){this.store.filterBy(function(record){return"count"===record.get("value")||model.hasField(me._getFieldForAggregationType(record.get("value")))}),this.store.findRecord("value",this.getValue())||this.setValue("count")},scope:this})}}},{type:"query"}]},_onModelsLoaded:function(models){this.models=_.values(models);var context=this.getContext(),modelNames=_.pluck(this.models,"typePath"),gridBoardConfig={xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:context.getScopedStateId("filters"),filterChildren:!0,modelNames:modelNames,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:this._getQuickFilters()}}}},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export to CSV...",handler:function(){window.location=Rally.ui.gridboard.Export.buildCsvExportUrl(this.down("rallygridboard").getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export",toolTipConfig:{html:"Export",anchor:"top",hideDelay:0}}}],context:context,modelNames:modelNames,storeConfig:{filters:this._getFilters()}};this.add(gridBoardConfig)},_getQuickFilters:function(){var quickFilters=[],types=this._getTypesSetting(),type=types[0];return types.length>1&&quickFilters.push("ModelType"),Rally.data.ModelTypes.isArtifact(type)&&(quickFilters.push("Owner"),Rally.data.ModelTypes.isPortfolioItem(type)?quickFilters.push("State"):quickFilters.push("ScheduleState")),quickFilters},_getTypesSetting:function(){return this.getSetting("types").split(",")},_getChartConfig:function(){return{xtype:this.getSetting("chartType"),storeType:"Rally.data.wsapi.artifact.Store",chartColors:["#FF8200","#F6A900","#FAD200","#8DC63F","#1E7C00","#337EC6","#005EB8","#7832A5","#DA1884","#C0C0C0"],storeConfig:{models:this._getTypesSetting(),context:this.getContext().getDataContext(),limit:1/0,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3},calculatorConfig:{calculationType:this.getSetting("aggregationType"),field:this.getSetting("aggregationField")}}},onTimeboxScopeChange:function(){this.callParent(arguments),this._addBoard()},_getChartFetch:function(){var field=this.getSetting("aggregationField"),aggregationType=this.getSetting("aggregationType"),fetch=["FormattedID","Name",field];return"count"!==aggregationType&&fetch.push(this._getFieldForAggregationType(aggregationType)),fetch},_getFieldForAggregationType:function(aggregationType){switch(aggregationType){case"acceptedleafcount":return"AcceptedLeafStoryCount";case"acceptedleafplanest":return"AcceptedLeafStoryPlanEstimateTotal";case"leafcount":return"LeafStoryCount";case"leafplanest":return"LeafStoryPlanEstimateTotal";case"prelimest":return"PreliminaryEstimateValue";default:return"PlanEstimate"}},_getChartSort:function(){var model=this.models[0],field=model.getField(this.getSetting("aggregationField"));return field&&"collection"!==field.getType()?[{property:this.getSetting("aggregationField"),direction:"ASC"}]:[]},_getFilters:function(){var queries=[],timeboxScope=this.getContext().getTimeboxScope();return this.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),timeboxScope&&_.any(this.models,timeboxScope.isApplicable,timeboxScope)&&queries.push(timeboxScope.getQueryFilter()),queries}});

            Rally.launchApp('CustomChartApp', {
                name:"Custom Chart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
